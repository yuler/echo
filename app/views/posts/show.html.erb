<div data-controller="audio-player"
     data-audio-player-simple-url-value="<%= @post.audio_url %>"
     data-audio-player-explanation-url-value="<%= @post.explanation_audio_url %>"
     class="min-h-screen bg-neutral-50">
  <%# Audio element %>
  <audio data-audio-player-target="audio" src="<%= @post.audio_url %>" preload="auto"></audio>

  <%# Main content container %>
  <main class="mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 pb-40 pt-8 sm:pt-12 md:pt-16" style="max-width: 960px">
    <%# Back navigation %>
    <nav class="mb-6 sm:mb-8">
      <%= link_to posts_path, class: "inline-flex items-center gap-2 text-sm sm:text-base text-neutral-600 hover:text-neutral-900 transition-colors" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
        <span>Episodes</span>
      <% end %>
    </nav>

    <%# Episode title %>
    <h1 class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-serif font-bold leading-tight tracking-tight mb-3 sm:mb-4" style="view-transition-name: post-<%= @post.id %>">
      <%= @post.title_en.presence || @post.title %>
    </h1>

    <%# Episode metadata %>
    <header class="flex items-center gap-3 sm:gap-4 text-xs sm:text-sm text-neutral-500 mb-8 sm:mb-12 pb-6 sm:pb-8 border-b border-neutral-200">
      <span class="font-semibold uppercase tracking-wider text-neutral-900"><%= @post.topics_list.first %></span>
      <% if @post.audio_duration.present? %>
        <span class="text-neutral-300">•</span>
        <span><%= @post.minutes_left %> min</span>
      <% end %>
    </header>

    <%# Mode toggle — Simple / Explanation %>
    <% if @post.explanation_audio_url.present? %>
      <div class="flex items-center gap-1 mb-8 sm:mb-12">
        <button class="px-3 py-1 rounded-full text-xs font-semibold transition-colors bg-neutral-900 text-white"
                data-audio-player-target="simpleBtn"
                data-action="click->audio-player#switchToSimple">Simple</button>
        <button class="px-3 py-1 rounded-full text-xs font-semibold transition-colors text-neutral-500 hover:bg-neutral-100"
                data-audio-player-target="explanationBtn"
                data-action="click->audio-player#switchToExplanation">Explanation</button>
      </div>
    <% end %>

    <%# Guide section %>
    <% if @post.guide.present? %>
      <section class="mb-8 sm:mb-12">
        <h2 class="text-xs sm:text-sm font-semibold uppercase tracking-wider text-neutral-500 mb-3 sm:mb-4">Guide</h2>
        <p class="text-sm sm:text-base md:text-lg leading-relaxed text-neutral-600"><%= @post.guide %></p>
      </section>
    <% end %>

    <%# Transcript content %>
    <article class="space-y-4 sm:space-y-6 md:space-y-8">
      <% paras = @post.bilingual_paragraphs %>
      <% english_paras = paras.select { |p| !p[:chinese] } %>
      <% para_duration = english_paras.any? ? (@post.audio_duration.to_f / english_paras.size) : 5 %>
      <% en_index = 0 %>

      <% paras.each do |para| %>
        <% if para[:chinese] %>
          <%# Chinese translation - hidden by default %>
          <p data-audio-player-target="translation" class="hidden text-sm sm:text-base md:text-lg leading-relaxed text-neutral-500 -mt-1 sm:-mt-2 pl-3 sm:pl-4 border-l-2 border-neutral-200">
            <%= para[:text] %>
          </p>
        <% else %>
          <%# English paragraph %>
          <% time_offset = (en_index * para_duration).round(2) %>
          <p data-audio-player-target="sentence"
             data-time="<%= time_offset %>"
             data-action="click->audio-player#seek"
             class="text-sm sm:text-base md:text-lg lg:text-xl leading-relaxed sm:leading-relaxed md:leading-relaxed cursor-pointer"
             style="opacity: 0.3; transition: opacity 0.3s">
            <% para[:text].split(/\s+/).each do |word| %>
              <span data-audio-player-target="word" style="transition: background-color 0.1s"><%= word %> </span>
            <% end %>
          </p>
          <% en_index += 1 %>
        <% end %>
      <% end %>
    </article>

  </main>

  <%# Fixed audio player at bottom %>
  <div class="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-neutral-200" data-audio-player-target="header">
    <div class="mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16" style="max-width: 960px">
      <%# Progress bar with wave effect %>
      <div class="pt-3 pb-2">
        <% wave_heights = 80.times.map { 25 + rand(50) } %>
        <div class="relative h-6 cursor-pointer flex items-end gap-[2px]" data-audio-player-target="progressBar" data-action="click->audio-player#scrub">
          <%# Waveform background %>
          <div class="absolute inset-0 flex items-end gap-[1px] justify-center opacity-20">
            <% wave_heights.each do |height| %>
              <div class="flex-1 bg-neutral-800 rounded-sm" style="height: <%= height %>%"></div>
            <% end %>
          </div>
          <%# Progress overlay — clips the waveform copy; inner div must match progressBar width %>
          <div class="absolute top-0 bottom-0 left-0 overflow-hidden" data-audio-player-target="progress" style="width: 0%">
            <div class="flex items-end gap-[1px] justify-center h-full" data-audio-player-target="progressInner">
              <% wave_heights.each do |height| %>
                <div class="flex-1 bg-neutral-800 rounded-sm" style="height: <%= height %>%; min-width: 0"></div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-neutral-400" style="font-size: 10px sm:font-size: 11px; font-variant-numeric: tabular-nums">
          <span data-audio-player-target="currentTime">0:00</span>
          <span data-audio-player-target="totalTime"><%= @post.formatted_duration %></span>
        </div>
      </div>


      <%# Playback controls — single row: speed (left) | skip/play (center) | translate (right) %>
      <div class="flex items-center justify-between py-3 pb-5">
        <%# Speed control — left %>
        <button class="px-2.5 sm:px-3 py-1.5 rounded-full border border-neutral-200 hover:bg-neutral-50 text-xs font-semibold text-neutral-600 transition-colors"
                data-action="click->audio-player#cycleSpeed"
                data-audio-player-target="speedBtn">
          1x
        </button>

        <%# Center playback group %>
        <div class="flex items-center gap-5 sm:gap-6 md:gap-8">
          <%# 15s back button %>
          <button class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full hover:bg-neutral-100 text-neutral-600 transition-colors" data-action="click->audio-player#rewind">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
              <text x="12" y="16.5" text-anchor="middle" font-size="8" font-weight="700" font-family="sans-serif" fill="currentColor">15</text>
            </svg>
          </button>

          <%# Play/Pause button %>
          <button class="flex items-center justify-center w-11 h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-neutral-900 text-white transition-transform hover:scale-105 active:scale-95 shadow-lg" data-action="click->audio-player#togglePlay">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" viewBox="0 0 24 24" fill="currentColor" data-audio-player-target="playIcon">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6 hidden" viewBox="0 0 24 24" fill="currentColor" data-audio-player-target="pauseIcon">
              <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
            </svg>
          </button>

          <%# 15s forward button %>
          <button class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full hover:bg-neutral-100 text-neutral-600 transition-colors" data-action="click->audio-player#forward">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 13c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2z"/>
              <text x="12" y="16.5" text-anchor="middle" font-size="8" font-weight="700" font-family="sans-serif" fill="currentColor">15</text>
            </svg>
          </button>
        </div>

        <%# Bilingual toggle — right %>
        <button class="flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 rounded-full hover:bg-neutral-50 text-neutral-600 transition-colors"
                data-action="click->audio-player#toggleTranslation"
                title="Toggle Chinese translation">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/>
            <path d="m22 22-5-10-5 10"/><path d="M14 18h6"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div data-controller="audio-player"
     data-audio-player-simple-url-value="<%= @post.audio_url %>"
     data-audio-player-explanation-url-value="<%= @post.explanation_audio_url %>"
     class="min-h-screen relative">
  <%= render "shared/background_wave" %>

  <%# Audio element %>
  <audio data-audio-player-target="audio" src="<%= @post.audio_url %>" preload="auto"></audio>

  <%# Main content container %>
  <main class="container-main pb-64!">

    <%# Post title %>
    <div class="mb-4">
      <h1 class="text-heading-1" style="view-transition-name: post-<%= @post.id %>">
        <%= @post.title_en.presence || @post.title %>
      </h1>
      <% if @post.title_en.present? && @post.title.present? && @post.title_en != @post.title %>
        <h2 data-audio-player-target="translation" class="hidden text-heading-3 text-neutral-500 mt-2">
          <%= @post.title %>
        </h2>
      <% end %>
    </div>

    <%# Post metadata %>
    <div class="mt-4 flex items-center gap-3 mb-8 pb-6 border-b border-neutral-200">
      <% if @post.topics_list.first.present? %>
        <span class="inline-flex items-center px-3 py-1 rounded-full border border-neutral-200 bg-white text-caption text-neutral-600 shadow-sm"><%= @post.topics_list.first %></span>
      <% end %>
      <% if @post.audio_duration.present? %>
        <div class="flex items-center gap-1.5 text-body-sm font-medium text-neutral-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span><%= @post.minutes_left %> min read</span>
        </div>
      <% end %>
    </div>

    <%# Mode toggle — Simple / Explanation (switch toggle) %>
    <% if @post.explanation_audio_url.present? %>
      <div class="mb-8 flex">
        <div class="relative inline-grid grid-cols-2 items-center bg-neutral-100/80 rounded-full p-1 border border-neutral-200/60 shadow-inner">
          <button class="relative z-10 px-5 py-2 rounded-full text-caption tracking-wide transition-colors text-white focus-ring"
                  data-audio-player-target="simpleBtn"
                  data-action="click->audio-player#switchToSimple">Simple</button>
          <button class="relative z-10 px-5 py-2 rounded-full text-caption tracking-wide transition-colors text-neutral-500 hover:text-neutral-800 focus-ring"
                  data-audio-player-target="explanationBtn"
                  data-action="click->audio-player#switchToExplanation">Explanation</button>
          <%# Sliding indicator %>
          <div class="absolute top-1 left-1 h-[calc(100%-8px)] w-[calc(50%-4px)] bg-neutral-900 rounded-full shadow-md transition-transform duration-300 ease-out"
               data-audio-player-target="toggleIndicator"
               style="transform: translateX(0)"></div>
        </div>
      </div>
    <% end %>

    <%# Guide section %>
    <% if @post.guide.present? %>
      <fieldset class="mb-8 border border-neutral-200/60 rounded-lg p-4 pt-2 pb-5">
        <legend class="text-overline tracking-widest text-neutral-400 px-2 ml-2">Guide</legend>
        <div class="px-1 text-body-lg text-neutral-600 leading-relaxed">
          <%= @post.guide %>
        </div>
      </fieldset>
    <% end %>

    <%# Transcript content %>
    <article class="space-y-6 pt-4 pb-8">
      <% @post.audio_sentences_with_translation.each do |group| %>
        <div class="space-y-1">
          <%# English sentences block %>
          <p class="text-body leading-relaxed">
            <% group[:sentences].each do |sentence| %>
              <% time_offset = sentence['frames'][0] / 1000.0 %>
              <span data-audio-player-target="sentence"
                    data-time="<%= time_offset %>"
                    data-action="click->audio-player#seek"
                    class="cursor-pointer focus-ring rounded transition-all duration-300"
                    style="opacity: 0.3;"><%= sentence['text'].strip %></span>
            <% end %>
          </p>

          <%# Chinese translation - hidden by default %>
          <% if group[:chinese].present? %>
            <p data-audio-player-target="translation" class="hidden text-body text-neutral-500 pl-3 border-l-2 border-neutral-200 mt-2">
              <%= group[:chinese] %>
            </p>
          <% end %>
        </div>
      <% end %>
    </article>

  </main>

  <%# Floating audio player widget at bottom %>
  <div class="fixed bottom-6 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 sm:w-[calc(100%-2rem)] max-w-2xl z-50 bg-white/95 backdrop-blur-md border border-neutral-200/60 shadow-xl shadow-neutral-900/5 rounded-2xl overflow-hidden" data-audio-player-target="header">
    <div class="px-4 sm:px-6">
      <%# Progress bar with wave effect %>
      <div class="pt-4 pb-2">
        <% wave_heights = 80.times.map { 25 + rand(50) } %>
        <div class="relative h-6 cursor-pointer flex items-end gap-[2px] overflow-hidden" data-audio-player-target="progressBar" data-action="click->audio-player#scrub">
          <%# Waveform background %>
          <div class="absolute inset-0 flex items-end gap-[1px] justify-center opacity-20">
            <% wave_heights.each do |height| %>
              <div class="flex-1 bg-neutral-800 rounded-sm" style="height: <%= height %>%"></div>
            <% end %>
          </div>
          <%# Progress overlay — clips the waveform copy; inner div must match progressBar width %>
          <div class="absolute top-0 bottom-0 left-0 overflow-hidden" data-audio-player-target="progress" style="width: 0%">
            <div class="flex items-end gap-[1px] justify-center h-full" data-audio-player-target="progressInner">
              <% wave_heights.each do |height| %>
                <div class="flex-1 bg-neutral-800 rounded-sm" style="height: <%= height %>%; min-width: 0"></div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-body-sm text-neutral-400" style="font-variant-numeric: tabular-nums">
          <span data-audio-player-target="currentTime">0:00</span>
          <span data-audio-player-target="totalTime"><%= @post.formatted_duration %></span>
        </div>
      </div>


      <%# Playback controls — single row: speed (left) | skip/play (center) | translate (right) %>
      <div class="flex items-center justify-between py-3 pb-4">
        <%# Speed control — left %>
        <button class="px-2.5 sm:px-3 py-1.5 rounded-full border border-neutral-200 hover:bg-neutral-50 text-body-sm font-semibold text-neutral-600 transition-colors"
                data-action="click->audio-player#cycleSpeed"
                data-audio-player-target="speedBtn">
          1x
        </button>

        <%# Center playback group %>
        <div class="flex items-center gap-5 sm:gap-6 md:gap-8">
          <%# 15s back button %>
          <button class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full hover:bg-neutral-100 text-neutral-600 transition-colors" data-action="click->audio-player#rewind">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
              <text x="12" y="16.5" text-anchor="middle" font-size="8" font-weight="700" font-family="sans-serif" fill="currentColor">15</text>
            </svg>
          </button>

          <%# Play/Pause button %>
          <button class="flex items-center justify-center w-11 h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-neutral-900 text-white transition-transform hover:scale-105 active:scale-95 shadow-lg shadow-neutral-900/20" data-action="click->audio-player#togglePlay">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" viewBox="0 0 24 24" fill="currentColor" data-audio-player-target="playIcon">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6 hidden" viewBox="0 0 24 24" fill="currentColor" data-audio-player-target="pauseIcon">
              <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
            </svg>
          </button>

          <%# 15s forward button %>
          <button class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full hover:bg-neutral-100 text-neutral-600 transition-colors" data-action="click->audio-player#forward">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 13c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2z"/>
              <text x="12" y="16.5" text-anchor="middle" font-size="8" font-weight="700" font-family="sans-serif" fill="currentColor">15</text>
            </svg>
          </button>
        </div>

        <%# Bilingual toggle — right %>
        <button class="flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 rounded-full hover:bg-neutral-50 text-neutral-600 transition-colors"
                data-action="click->audio-player#toggleTranslation"
                title="Toggle Chinese translation">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/>
            <path d="m22 22-5-10-5 10"/><path d="M14 18h6"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>
